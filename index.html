<html>
<head>
<title>test</title>
<script src="lastfm.js"></script>
<script type="text/javascript">
window.onload = main;

var lastfm = new LastFM('39c795e91c62cf9d469392c7c2648c80');

var user;
var realname;
var register_date;

function main() {
    document.getElementById('sandbox_form').onsubmit = function() { 
        process();
        return false 
    };
}

function process() {
    clear_console();
    user = document.getElementById('user').value;
    
    lastfm.get_user(user, get_user_callback);
    /*lastfm.get_history(user, from, to, function(uri) {
        window.open(uri);
        document.getElementById('output').innerHTML = uri;
    }); */   
}

function get_user_callback(result) {
        realname = result.user.realname;
        register_date = parseInt(result.user.registered.unixtime, 10);
        lastfm.get_weeklycharts(user, get_weeklycharts_callback);
}

function get_weeklycharts_callback(result) {
    var chart = result.weeklychartlist.chart;
    /*for (var i = chart.length-1; i >= 0 &&
            chart[i].to > register_date; i--) {
        process_week(parseInt(chart[i].from, 10), 
            parseInt(chart[i].to, 10));
    }*/
    
    var i = chart.length-1;
    function loop() {
        setTimeout(function() {
            process_week(chart[i].from, chart[i].to);
            print('<br/>');
            i--;
            if (i >= 0 && chart[i].to > register_date) {
                loop();
            }
        }, 1000);
    }
    
    loop();
    
}

function process_week(from, to) {
    lastfm.get_weeklyartistchart(user, from, to, function(result) {
        print(unix2localtime(from) + " - " + unix2localtime(to));
        var artists = result.weeklyartistchart.artist;
        var total = 0;
        
        for (var i = 0; i < artists.length; i++) {
            print(artists[i].name + " " + artists[i].playcount);
            total += parseInt(artists[i].playcount, 10);
        }
        print("Total: " + total);
    });
}

function unix2localtime(time) {
    time = parseInt(time, 10);
    var date = new Date(time * 1000);
    return date.toLocaleString();
}

function print(str) {
    var div = document.createElement('div');
    div.innerHTML = str;
    document.getElementById('output').appendChild(div);
}

function clear_console() {
    document.getElementById('output').innerHTML = '';
}

</script>

</head>
<body>
    <form id='sandbox_form'>
        user: <input type='text' id='user' name='user'></input><br/>
        <input type='submit' value='go'></input>
    </form>
    <div id='output'>
    
    </div>
</body>
</html>