<html>
<head>
    <title>test</title>
    <script src='/js/jquery-1.10.2.min.js'></script>
    <script type="text/javascript" src="/js/highcharts.js"></script>
    <script type='text/javascript'>
    window.onload = process;

    var user = '{{ user }}';

    function process() {
        $('#usr_input').val(user);
        $.getJSON('/data?user=' + user + 
                '&max_tpw=10').done(render).fail(disp_error);
    }

    function render(data, status, jqXHR) {
        if (data.error) {
            document.getElementById('chart').innerHTML = data.error;
        } else if (data.status) {
            document.getElementById('chart').innerHTML = data.status;
        } else {
            var tags = {}
            for (var w_i = data.weeks.length-1; w_i >= 0; w_i--) {
                var week = data.weeks[w_i];
                for (var t_i = 0; t_i < week.tags.length; t_i++) {
                    var tag_obj = week.tags[t_i];
                    if (tags[tag_obj.tag]) {
                        tags[tag_obj.tag].push([parseInt(week.from) * 1000, 
                                parseInt(tag_obj.plays)]) 
                    } else {
                        tags[tag_obj.tag] = [[parseInt(week.from) * 1000, 
                            parseInt(tag_obj.plays)]]
                    }
                }        
            }

            var series = [];
            for (var tag in tags) {
                series.push({
                    name: tag, 
                    data: tags[tag],
                    step: 'left',
                    pointInterval: 7 * 24 * 3600 * 1000
                });
            }

            $(function () {
                $('#chart').highcharts({
                    title: {
                        text: 'Genre data for andruun'
                    },
                    chart: {
                        zoomType: 'x'
                    },
                    xAxis: {
                        startOfWeek: 0,
                        type: 'datetime',
                        dateTimeLabelFormats: {
                            week: '%e. %b'
                        },
                        maxZoom: 7 * 24 * 3600 * 1000
                    },
                    yAxis: {
                        title: {
                            text: 'Listens' 
                        },
                        min: 0
                    },
                    tooltip: {
                        useHTML: true,
                        crosshairs: true,
                        formatter: function() {
                            return '<b>' + this.series.name + '</b><br/>' +
                                'Week from ' + Highcharts.dateFormat('%a, %b %e, %Y', this.x) + '<br/>' + 
                                this.series.name + ': ' + this.y + '<br/>' +
                                '<a href="http://www.last.fm/user/' + user + '/charts?charttype=weekly&subtype=artist&range=' + this.x/1000 + '-' + (this.x/1000 + 604800) + '" target="_blank">view artist chart</a>';
                        },
                        positioner: function(boxWidth, boxHeight, point) { 
                            return {x:point.plotX, y:point.plotY - 50}; 
                        }
                    },
                    series: series
                    });
           });
        }
    }

    function disp_error(jqxhr, textStatus, error) {
        alert(textStatus + ': ' + error);
    }

    function unix2localtime(time) {
        time = parseInt(time, 10);
        var date = new Date(time * 1000);
        return date.toLocaleString();
    }
    </script>
</head>
<body>
    <form id='user_form' method='get' action='/graph'>
        user: <input type='text' id='usr_input' name='user'></input><br/>
        <input type='submit' value='go'></input>
    </form>
    <a href="http://www.last.fm/user/{{user}}">{{user}}</a>
    <br/><br/>
    <div id='chart'>
        Getting data...
    </div>
</body>
</html>
